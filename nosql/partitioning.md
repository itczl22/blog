分片(partitioning) 就是将数据拆分到多个redis实例的过程, 这样每个Redis实例将只包含完整数据的一部分


__分片的好处__

* 它允许使用许多计算机的内存总和来创建更大的数据库, 如果不进行分区则只能使用一台计算机可以支持的内存量

* 它允许将计算能力扩展到多核和多台计算机, 并将网络带宽扩展到多台计算机和网络适配器


__分片的弊端__

* 分片不支持多建操作, 比如mget\mset, 但是可以使用pipeline, 不过pipeline不能保证顺序, 因为多个分片的响应顺序不能保证. redis原生的mset操作是原子性的, 所有给定的key都会在同一时刻被设置, 但分片模式下多个key可能被映射至不同实例, 由于网络或其他原因可能出现一个分片成功另一分片失败的情况

* 不能使用涉及多个key的redis事务

* 数据处理会更加复杂, 例如: 必须处理多个RDB / AOF文件, 并且要备份数据则需要从多个实例和主机聚合持久性文件

* 故障的恢复的处理会比较麻烦, 可能需要重新梳理Master和Slave的关系, 并调整每个复制集里面的数据

* 添加和删除redis实例比较复杂. Redis Cluster支持大多数透明的数据重新平衡, 并能够在运行时添加和删除节点, 但是其他系统（例如客户端分区和代理）不支持此功能, 但是可以通过“ 预分片”的技术来解决


__常见的分片方式__

* 范围分片, 比如哈希槽(hash slot)
  它是通过将对象范围映射到特定的redis实例中来实现的. 它的缺点是需要维护范围映射到实例的表, 因此redis中的范围分区通常是不可取的, 因为它比其他替代分区方法效率低得多

* hash分片, 比如一致性hash
  该方案适用于任何key, 获取key名称并使用哈希函数(例如，crc32哈希函数)将其转换为数字, 用这个数字对redis实力数使用取模运算, 获取key对应的机器


__常见的分片实现方法__

* 路由查询, 比如官方推出的redis cluster 
可以将查询发送到随机实例, 该实例将确保将查询转发到正确的节点, 在 redis3.0 实现的redis cluster是一个混合路由查询. 当客户端访问某个服务端时, 服务端计算对应的key应该存储在哪个节点, 然后把结果返回给客户端, 客户端再去对应的节点操作key, 是一个重定向的过程. 服务器端实现集群需要客户端语言实现服务器集群的协议, 目前大多语言都有redis-cluster客户端的实现版本.   
go的实现参考：https://github.com/wuxibin89/redis-go-cluster 

* 代理分片, 比如twempoxy (http://antirez.com/news/44)
此方式是借助一个代理服务器实现数据分片, 客户端直接与proxy连接, proxy计算集群节点信息并把请求发送到对应的集群节点. 降低了客户端的复杂度, 需要proxy收集集群节点信息. Twemproxy是twitter开源的实现这一功能的proxy, 这个实现方式在客户端和服务器之间加了一个proxy

* 客户端分片(redis sharding)
即客户端自己计算数据的key应该在哪个redis实例上存储, 然后直接访问redis实例,  此方法的好处是降低了服务器集群的复杂度, 服务器是独立的, 服务器之前没有任何关联. 多数redis客户端库实现了此功能，这种方式的缺点是客户端需要实时知道当前集群节点的联系信息，同时当添加一个新的节点时，客户端要支持动态sharding.


__预分片-Presharding__

分区的问题是, 除非我们将redis用作缓存, 否则添加和删除节点可能很棘手  
由于redis的占用空间非常小且重量轻（备用实例使用1 MB内存）因此解决此问题的简单方法是一开始使用许多实例. 即使仅有一台服务器启动, 也可以决定从一开始就生活在分布式环境中, 并使用分区在单个服务器上运行多个redis实例. 对于大多数用户而言, 32或64个实例可以解决问题. 我们新闻默认启动64个实例

预分配的处理过程
* 在新的服务器上创建空的redis实例

* 配置新的redis实例作为源实例的从实例, 将源数据导到新实例上

* 停止客户端(分片操作在客户端上时)或代理服务器(分片操作在代理上)

* 将客户端或者代理配置的实例ip更新为新的服务器地址. 注意此处是替换老的ip地址, 不能进行追加或调换各地址的顺序

* 在新服务器上发送SLAVEOF NO ONE命令, 使其不再作为从实例

* 用新的配置重启客户端

* 最后停止老服务器上不再使用的旧实例

* 此过程需要人工干预, 而且影响数据的正常访问


__参考__

* https://redis.io/topics/partitioning
